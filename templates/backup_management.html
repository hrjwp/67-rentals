<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Management - 67 Rentals</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/templatemo-graph-page.css') }}">
    <style>
        /* --- Confidential / Anti-exfiltration (deterrence) --- */
    * {
            /* Security: Prevent text selection */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        /* --- Security Overlays Start --- */
        .security-banner {
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-size: 14px;
        }
        .session-timer {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            font-weight: 600;
            color: var(--secondary-color);
            border: 2px solid var(--primary-color);
        }
        .timer-warning {
            background: #ff6b6b !important;
            color: white !important;
            animation: pulse 1s infinite;
            border-color: #ff6b6b;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        .watermark-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9997;
            overflow: hidden;
        }
        .watermark-text {
            position: absolute;
            font-size: 80px;
            font-weight: bold;
            color: rgba(61, 64, 91, 0.05);
            white-space: nowrap;
            transform: rotate(-20deg);
        }
        .watermark-text:nth-child(1) {
            top: 10%;
            left: 5%;
        }
        .watermark-text:nth-child(2) {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg);
        }
        .watermark-text:nth-child(3) {
            bottom: 10%;
            right: 5%;
        }
        .blocked-action {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff6b6b;
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 10001;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        .session-expired {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(61, 64, 91, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
        }
        .expired-content {
            background: white;
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
        }
        .expired-content h1 {
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        .expired-content .btn {
            background: var(--custom-btn-bg-color);
            color: var(--secondary-color);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
        }
        .activity-log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            z-index: 9998;
            border-left: 4px solid var(--secondary-color);
        }
        .activity-log h4 {
            margin-bottom: 10px;
            color: var(--secondary-color);
            font-weight: 700;
        }
        .activity-item {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
            color: #666;
        }
        /* --- Security Overlays End --- */
        @media print {
            body * { display: none !important; }
            body::before {
                content: "Printing is disabled for CONFIDENTIAL pages.";
                display: block;
                padding: 40px;
                font-size: 22px;
                font-weight: 800;
                color: #111;
            }
        }

        .backup-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: var(--section-bg-color);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        .stat-label {
            color: var(--p-color);
            font-size: 0.9em;
        }
        .backup-table {
            width: 100%;
            margin-top: 30px;
            background: var(--section-bg-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .backup-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .backup-table th,
        .backup-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .backup-table th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
        }
        .backup-table tr:hover {
            background: rgba(255,255,255,0.02);
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .status-success {
            background: #28a745;
            color: white;
        }
        .status-failed {
            background: #dc3545;
            color: white;
        }
        .status-pending {
            background: #ffc107;
            color: #000;
        }
        .status-verified {
            background: #17a2b8;
            color: white;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .checksum {
            font-family: monospace;
            font-size: 0.85em;
            color: var(--p-color);
            word-break: break-all;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--p-color);
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

    </style>
</head>
<body>
        <!-- Security Overlays -->
    <div class="security-banner">
        Data Copying Disabled - Session: <span id="sessionId"></span>
    </div>

    <div class="watermark-overlay">
        <div class="watermark-text">CONFIDENTIAL</div>
        <div class="watermark-text">CONFIDENTIAL</div>
        <div class="watermark-text">CONFIDENTIAL</div>
    </div>
    <div class="blocked-action" id="blockedAlert">
        <h2>üö´ Action Blocked</h2>
        <p id="blockedMessage">This action has been blocked for security reasons.</p>
    </div>
    <div class="session-expired" id="sessionExpired">
        <div class="expired-content">
            <h1>‚è∞ Session Expired</h1>
            <p>Your session has timed out for security reasons.</p>
            <p style="margin-top: 15px; color: #666;">All attempted actions have been logged.</p>
            <button class="btn" onclick="location.reload()">Login Again</button>
        </div>
    </div>

    <!-- Navigation -->
    {% include 'partials/navbar_graph.html' %}

    <!-- Backup Management Section -->
    <section class="dashboard-section" style="padding-top: 140px; min-height: 100vh;">
        <div class="dashboard-container">
            <h2 class="section-title">Backup Management</h2>
            
            <div id="alert-container"></div>

            <!-- Statistics -->
            <div class="backup-stats" id="backup-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Backups</div>
                    <div class="stat-value" id="stat-total">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Successful</div>
                    <div class="stat-value" id="stat-success" style="color: #28a745;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Failed</div>
                    <div class="stat-value" id="stat-failed" style="color: #dc3545;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Size</div>
                    <div class="stat-value" id="stat-size">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Verified</div>
                    <div class="stat-value" id="stat-verified" style="color: #17a2b8;">-</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="margin: 30px 0; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="cta-button" onclick="createBackup()">Create Backup Now</button>
                <button class="cta-button secondary" onclick="loadBackups()">Refresh List</button>
                <button class="cta-button secondary" onclick="loadStats()">Refresh Stats</button>
                <button class="cta-button secondary" onclick="cleanupOldBackups()">Cleanup Old Backups</button>
            </div>

            <!-- Recovery Info -->
            <div class="alert alert-info" style="margin: 20px 0;">
                <strong> Recover Deleted Entries:</strong>
                Find a backup created <strong>before</strong> you deleted the entry, then click <strong>"Restore"</strong> on that backup. 
                This will restore all listings (including deleted ones) from that backup. 
                <strong>Important:</strong> Restart your Flask app after restoring to see the recovered entries.
            </div>

            <!-- Backup List -->
            <div class="backup-table">
                <div id="backup-loading" class="loading">Loading backups...</div>
                <table id="backup-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Status</th>
                            <th>Verification</th>
                            <th>Created</th>
                            <th>Checksum</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="backup-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p class="copyright">¬© 2026 67 Rentals. All rights reserved.</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/templatemo-graph-script.js') }}"></script>
    <script>
  // Define user ID first for security scripts
        const CURRENT_USER_ID = {{ session.get('user_id', 0) | tojson }};
        // --- Security Scripts Start ---
        const SESSION_DURATION = 900;
        let sessionTimeRemaining = SESSION_DURATION;
        let sessionInterval;
        let activityLogs = [];
        let screenshotAttempts = 0;
        const _lastReportedAt = {};
        // Simple in-page activity monitor so we can safely call logActivity(...)
        function logActivity(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            activityLogs.unshift({ timestamp, message, level });
            if (activityLogs.length > 50) {
                activityLogs.pop();
            }
            let container = document.getElementById('activityLog');
            if (!container) {
                container = document.createElement('div');
                container.id = 'activityLog';
                container.className = 'activity-log';
                container.innerHTML = '<h4>Activity Monitor</h4><div id="activityItems"></div>';
                document.body.appendChild(container);
            }
            const itemsEl = document.getElementById('activityItems');
            if (itemsEl) {
                itemsEl.innerHTML = activityLogs
                    .map(log => `<div class="activity-item">[${log.timestamp}] ${log.message}</div>`)
                    .join('');
            }
        }
        // Generate unique session ID
        const sessionId = 'SID-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        document.getElementById('sessionId').textContent = sessionId;
        async function reportSecurityEvent(eventType, severity, description, actionTaken) {
            // Simple client-side throttle to avoid flooding logs
            const key = `${eventType}:${severity}`;
            const now = Date.now();
            if (_lastReportedAt[key] && now - _lastReportedAt[key] < 3000) return;
            _lastReportedAt[key] = now;
            try {
                await fetch('/api/log-security-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    keepalive: true,
                    body: JSON.stringify({
                        user_id: CURRENT_USER_ID,
                        event_type: eventType,
                        severity,
                        // Include page context so admins can see where it happened
                        description: `${description} | Page: ${window.location.pathname}`,
                        action_taken: actionTaken
                    })
                });
            } catch (e) {
                // Best-effort logging; ignore failures
            }
        }
        function showBlockedAlert(message) {
            const alert = document.getElementById('blockedAlert');
            document.getElementById('blockedMessage').textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 2000);
        }
        function startSessionTimer() {
            sessionInterval = setInterval(() => {
                sessionTimeRemaining--;
                const minutes = Math.floor(sessionTimeRemaining / 60);
                const seconds = sessionTimeRemaining % 60;
                const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timeLeft').textContent = timeDisplay;
                const timerEl = document.getElementById('sessionTimer');
                if (sessionTimeRemaining <= 60) {
                    timerEl.classList.add('timer-warning');
                }
                if (sessionTimeRemaining <= 0) {
                    clearInterval(sessionInterval);
                    document.getElementById('sessionExpired').style.display = 'flex';
                    logActivity('Session expired - Auto logout', 'warning');
                    reportSecurityEvent(
                        'Session Timeout',
                        'Medium',
                        `Client session timer expired (SID=${sessionId})`,
                        'Displayed session expired overlay'
                    );
                }
            }, 1000);
        }
        function resetSessionTimer() {
            sessionTimeRemaining = SESSION_DURATION;
            document.getElementById('sessionTimer').classList.remove('timer-warning');
        }
        // Security event handlers
        document.addEventListener('copy', (e) => {
            e.preventDefault();
            showBlockedAlert('Copying data is not allowed for security reasons.');
            logActivity('Copy attempt blocked', 'warning');
            reportSecurityEvent('Copy/Paste Attempt', 'Medium', `Copy blocked (SID=${sessionId})`, 'Blocked copy');
        });
        document.addEventListener('cut', (e) => {
            e.preventDefault();
            showBlockedAlert('Cutting data is not allowed for security reasons.');
            logActivity('Cut attempt blocked', 'warning');
            reportSecurityEvent('Copy/Paste Attempt', 'Medium', `Cut blocked (SID=${sessionId})`, 'Blocked cut');
        });
        document.addEventListener('paste', (e) => {
            e.preventDefault();
            showBlockedAlert('Pasting is not allowed in this secure area.');
            logActivity('Paste attempt blocked', 'warning');
            reportSecurityEvent('Copy/Paste Attempt', 'Medium', `Paste blocked (SID=${sessionId})`, 'Blocked paste');
        });
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showBlockedAlert('Right-click menu is disabled in secure areas.');
            logActivity('Context menu blocked', 'warning');
        });
        function handlePrintScreen(e) {
            const isPrintScreen =
                e.key === 'PrintScreen' ||
                e.key === 'Print Screen' ||
                e.keyCode === 44 ||
                e.which === 44;
            if (!isPrintScreen) return false;
            screenshotAttempts++;
            showBlockedAlert(`Screenshot attempt detected. Session: ${sessionId}`);
            logActivity(`Screenshot attempt #${screenshotAttempts}`, 'warning');
            reportSecurityEvent(
                'Screenshot Prevented',
                'High',
                `PrintScreen detected (attempt #${screenshotAttempts}) (SID=${sessionId})`,
                e.metaKey ? 'Detected Win+PrintScreen' : 'Detected PrintScreen'
            );
            // Best-effort clipboard clear (may be unavailable on HTTP)
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText('').catch(() => {});
                }
            } catch (err) {
                // ignore
            }
            document.body.style.filter = 'invert(1)';
            setTimeout(() => { document.body.style.filter = 'none'; }, 100);
            return true;
        }
        document.addEventListener('keydown', (e) => {
            if (e.keyCode === 123) {
                e.preventDefault();
                showBlockedAlert('Developer tools are disabled.');
                logActivity('DevTools access blocked', 'warning');
                reportSecurityEvent('Security Alert', 'High', `DevTools blocked (F12) (SID=${sessionId})`, 'Blocked DevTools');
                return false;
            }
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) {
                e.preventDefault();
                showBlockedAlert('Developer tools are disabled.');
                logActivity('DevTools shortcut blocked', 'warning');
                reportSecurityEvent('Security Alert', 'High', `DevTools shortcut blocked (SID=${sessionId})`, 'Blocked DevTools shortcut');
                return false;
            }
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                showBlockedAlert('Viewing source code is disabled.');
                logActivity('View source blocked', 'warning');
                return false;
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                showBlockedAlert('Saving pages is disabled.');
                logActivity('Save page blocked', 'warning');
                reportSecurityEvent('Export Blocked', 'High', `Save page blocked (SID=${sessionId})`, 'Blocked Ctrl+S');
                return false;
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                showBlockedAlert('Printing is disabled for security reasons.');
                logActivity('Print attempt blocked', 'warning');
                reportSecurityEvent('Export Blocked', 'High', `Print blocked (SID=${sessionId})`, 'Blocked Ctrl+P');
                return false;
            }
            // Try to detect PrintScreen on keydown (may be swallowed by OS in some cases)
            if (handlePrintScreen(e)) {
                // preventDefault won't always stop OS screenshot, but can stop page behaviors
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            resetSessionTimer();
        });
        // Also listen on keyup in CAPTURE phase (some browsers only expose PrintScreen here)
        window.addEventListener('keyup', (e) => {
            if (handlePrintScreen(e)) {
                e.preventDefault();
                e.stopPropagation();
            }
        }, true);
        // Detect Snipping Tool (Windows Key + Shift + S) and other combinations
        document.addEventListener('keyup', (e) => {
            if (e.key === 's' && e.shiftKey && e.metaKey) {
                screenshotAttempts++;
                showBlockedAlert(`Snipping tool detected! Attempt #${screenshotAttempts} logged.`);
                logActivity(`Snipping tool attempt #${screenshotAttempts}`, 'warning');
                reportSecurityEvent(
                    'Screenshot Prevented',
                    'High',
                    `Snipping tool shortcut suspected (attempt #${screenshotAttempts}) (SID=${sessionId})`,
                    'Detected Win+Shift+S'
                );
            }
        });
        // Detect visibility change (often triggered by screen capture tools overlaying the window)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Don't log to DB on tab switches; this causes false positives.
                // Keep only a visual deterrent.
                document.body.style.filter = 'blur(10px)';
            } else {
                document.body.style.filter = 'none';
            }
        });
        // Detect focus loss (often happens when clicking "New" on Snipping Tool)
        window.addEventListener('blur', () => {
            logActivity('Window lost focus - possible screenshot tool active', 'warning');
        });
        window.addEventListener('beforeprint', (e) => {
            e.preventDefault();
            showBlockedAlert('Printing is disabled for security reasons.');
            logActivity('Print blocked', 'warning');
            return false;
        });
        // Monitor for Screen Recording API usage
        setInterval(() => {
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                const now = Date.now();
                if (!window.lastCaptureWarning || now - window.lastCaptureWarning > 60000) {
                    window.lastCaptureWarning = now;
                    logActivity('Screen capture API detected - monitoring', 'warning');
                }
            }
        }, 30000);
        document.addEventListener('mousemove', resetSessionTimer);
        document.addEventListener('click', resetSessionTimer);
        document.addEventListener('scroll', resetSessionTimer);
        window.addEventListener('beforeunload', (e) => {
            logActivity(`Session ended - ${screenshotAttempts} screenshot attempts detected`, 'info');
        });
        // Start session timer on page load
        startSessionTimer();
        // --- Security Scripts End ---

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const mb = bytes / (1024 * 1024);
            return mb.toFixed(2) + ' MB';
        }

        function createBackup() {
            if (!confirm('Create a new backup now? This may take a few moments.')) return;
            
            fetch('/admin/backup/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ include_files: true })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Backup created successfully: ${data.backup_file} (${data.backup_size_mb} MB)`, 'success');
                    loadBackups();
                    loadStats();
                } else {
                    showAlert('Backup failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                showAlert('Error creating backup: ' + err.message, 'error');
            });
        }

        function loadStats() {
            fetch('/admin/backup/stats')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('stat-total').textContent = stats.total_backups || 0;
                    document.getElementById('stat-success').textContent = stats.successful_backups || 0;
                    document.getElementById('stat-failed').textContent = stats.failed_backups || 0;
                    document.getElementById('stat-size').textContent = stats.total_size_mb ? stats.total_size_mb + ' MB' : '0 MB';
                    document.getElementById('stat-verified').textContent = stats.verified_backups || 0;
                }
            })
            .catch(err => console.error('Error loading stats:', err));
        }

        function loadBackups() {
            document.getElementById('backup-loading').style.display = 'block';
            document.getElementById('backup-table').style.display = 'none';
            
            fetch('/admin/backup/list')
            .then(r => r.json())
            .then(data => {
                document.getElementById('backup-loading').style.display = 'none';
                
                if (data.success) {
                    const tbody = document.getElementById('backup-tbody');
                    tbody.innerHTML = '';
                    
                    if (data.backups.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No backups found</td></tr>';
                    } else {
                        data.backups.forEach(backup => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${backup.filename || backup.backup_filename || '-'}</td>
                                <td>${backup.backup_type || 'Unknown'}</td>
                                <td>${formatBytes(backup.size || backup.backup_size_bytes)}</td>
                                <td><span class="status-badge status-${backup.status === 'Success' ? 'success' : backup.status === 'Failed' ? 'failed' : 'pending'}">${backup.status || 'Unknown'}</span></td>
                                <td><span class="status-badge status-${backup.verification_status === 'Verified' ? 'verified' : 'pending'}">${backup.verification_status || 'Pending'}</span></td>
                                <td>${formatDate(backup.created || backup.timestamp)}</td>
                                <td class="checksum" title="${backup.checksum_sha256 || ''}">${backup.checksum_sha256 ? backup.checksum_sha256.substring(0, 16) + '...' : '-'}</td>
                                <td class="action-buttons">
                                    ${backup.status === 'Success' ? `<button class="btn-sm btn-success" onclick="verifyBackup('${backup.filename || backup.backup_filename}')">Verify</button>` : ''}
                                    ${backup.status === 'Success' ? `<button class="btn-sm btn-warning" onclick="restoreBackup('${backup.filename || backup.backup_filename}')" style="background: #ffc107; color: #000; border: none;">Restore</button>` : ''}
                                    <button class="btn-sm btn-primary" onclick="viewBackupDetails('${backup.filename || backup.backup_filename}')">Details</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    document.getElementById('backup-table').style.display = 'table';
                } else {
                    showAlert('Error loading backups: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                document.getElementById('backup-loading').style.display = 'none';
                showAlert('Error loading backups: ' + err.message, 'error');
            });
        }

        function verifyBackup(filename) {
            fetch(`/admin/backup/verify/${encodeURIComponent(filename)}`, {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.verification.verified) {
                    showAlert(`Backup verified successfully! Checksum: ${data.verification.checksum.substring(0, 16)}...`, 'success');
                    loadBackups();
                } else {
                    showAlert('Verification failed: ' + (data.verification.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                showAlert('Error verifying backup: ' + err.message, 'error');
            });
        }

        function viewBackupDetails(filename) {
            fetch('/admin/backup/list')
            .then(r => r.json())
            .then(data => {
                const backup = data.backups.find(b => (b.filename || b.backup_filename) === filename);
                if (backup) {
                    const details = `
Filename: ${backup.filename || backup.backup_filename}
Type: ${backup.backup_type || 'Unknown'}
Size: ${formatBytes(backup.size || backup.backup_size_bytes)}
Status: ${backup.status || 'Unknown'}
Verification: ${backup.verification_status || 'Pending'}
Created: ${formatDate(backup.created || backup.timestamp)}
Checksum: ${backup.checksum_sha256 || 'N/A'}
Tables Backed Up: ${Array.isArray(backup.tables_backed_up) ? backup.tables_backed_up.join(', ') : 'N/A'}
Files Included: ${backup.files_included || 0}
Cloud Backup: ${backup.cloud_backup_enabled ? 'Yes' : 'No'}
                    `;
                    alert(details);
                }
            });
        }

        function restoreBackup(filename) {
            if (!confirm('‚ö†Ô∏è WARNING: This will restore data from backup, including deleted listings.\n\n' +
                        'This will:\n' +
                        '- Restore all listings from the backup (overwrites current listings)\n' +
                        '- Optionally restore database tables (skips duplicates safely)\n\n' +
                        'Make sure you have a recent backup before proceeding!\n\n' +
                        'Continue with restore?')) return;
            
            const restoreTables = confirm('Restore database tables too?\n\n' +
                                        'OK = Full restore (listings + database, duplicates skipped)\n' +
                                        'Cancel = Listings only (recommended for recovering deleted entries)') ? null : [];
            
            fetch('/admin/backup/restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    backup_filename: filename,
                    restore_tables: restoreTables
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    let message = 'Backup restored successfully!\n\n';
                    if (data.restored_in_memory && data.restored_in_memory.listings) {
                        message += `‚úÖ Restored ${data.restored_in_memory.listings} listing(s)\n`;
                    }
                    if (data.restored_tables && data.restored_tables.length > 0) {
                        message += `‚úÖ Restored database tables: ${data.restored_tables.join(', ')}\n`;
                    }
                    message += '\n‚ö†Ô∏è Please restart your Flask app to see restored listings.';
                    showAlert(message, 'success');
                    loadBackups();
                    loadStats();
                } else {
                    showAlert('Restore failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                showAlert('Error restoring backup: ' + err.message, 'error');
            });
        }

        function cleanupOldBackups() {
            if (!confirm('Delete backups older than retention period? This cannot be undone.')) return;
            
            fetch('/admin/backup/cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ keep_days: 30 })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Cleaned up ${data.deleted_files.length} old backup(s)`, 'success');
                    loadBackups();
                    loadStats();
                } else {
                    showAlert('Cleanup failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                showAlert('Error cleaning up backups: ' + err.message, 'error');
            });
        }

        // Position security banner below navbar dynamically
        function positionSecurityBanner() {
            const navbar = document.getElementById('navbar');
            const banner = document.querySelector('.security-banner');
            if (navbar && banner) {
                const navbarHeight = navbar.offsetHeight;
                banner.style.top = navbarHeight + 'px';
                // Adjust section padding to account for banner
                const section = document.querySelector('.dashboard-section');
                if (section) {
                    section.style.paddingTop = (navbarHeight + 60) + 'px';
                }
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            positionSecurityBanner();
            // Re-position on window resize
            window.addEventListener('resize', positionSecurityBanner);

            loadStats();
            loadBackups();

            // Auto-refresh every 60 seconds
            setInterval(() => {
                loadStats();
                loadBackups();
            }, 60000);
        });
    </script>

</body>
</html>
